<?xml version="1.0" encoding="UTF-8"?>
<jcr:root
    xmlns:sling="http://sling.apache.org/jcr/sling/1.0"
    xmlns:cq="http://www.day.com/jcr/cq/1.0"
    xmlns:jcr="http://www.jcp.org/jcr/1.0"
    jcr:primaryType="cq:Component"
    jcr:title="Performance Table"
    sling:resourceSuperType="core/wcm/components/core-component"
    componentGroup="MySite - Content"/>

<?xml version="1.0" encoding="UTF-8"?>
<jcr:root
    xmlns:sling="http://sling.apache.org/jcr/sling/1.0"
    xmlns:cq="http://www.day.com/jcr/cq/1.0"
    xmlns:jcr="http://www.jcp.org/jcr/1.0"
    jcr:primaryType="nt:unstructured"
    jcr:title="Performance Table"
    sling:resourceType="cq/gui/components/authoring/dialog">

    <content
        jcr:primaryType="nt:unstructured"
        sling:resourceType="granite/ui/components/coral/foundation/fixedcolumns">

        <items jcr:primaryType="nt:unstructured">
            <column
                jcr:primaryType="nt:unstructured"
                sling:resourceType="granite/ui/components/coral/foundation/container">

                <items jcr:primaryType="nt:unstructured">

                    <!-- 表头 -->
                    <headers
                        jcr:primaryType="nt:unstructured"
                        sling:resourceType="granite/ui/components/coral/foundation/form/multifield"
                        fieldLabel="Headers"
                        fieldDescription="Add column headers"
                        composite="{Boolean}false"
                        name="./headers">
                        <field
                            jcr:primaryType="nt:unstructured"
                            sling:resourceType="granite/ui/components/coral/foundation/form/textfield"
                            name="./header"
                            emptyText="Header text"/>
                    </headers>

                    <!-- 表格行（每行是 composite） -->
                    <rows
                        jcr:primaryType="nt:unstructured"
                        sling:resourceType="granite/ui/components/coral/foundation/form/multifield"
                        fieldLabel="Rows"
                        fieldDescription="Add table rows"
                        composite="{Boolean}true"
                        name="./rows">

                        <field
                            jcr:primaryType="nt:unstructured"
                            sling:resourceType="granite/ui/components/coral/foundation/container">
                            <items jcr:primaryType="nt:unstructured">

                                <!-- 可选：行标识/左侧第一列（比如 Index 名称） -->
                                <rowLabel
                                    jcr:primaryType="nt:unstructured"
                                    sling:resourceType="granite/ui/components/coral/foundation/form/textfield"
                                    fieldLabel="Row label (first cell)"
                                    name="./rowLabel"
                                    emptyText="e.g. Hang Seng Index"/>

                                <!-- cells multifield：这一行的所有 cell（包括第一列或仅右侧列都行） -->
                                <cells
                                    jcr:primaryType="nt:unstructured"
                                    sling:resourceType="granite/ui/components/coral/foundation/form/multifield"
                                    fieldLabel="Cells"
                                    fieldDescription="Add cells for this row"
                                    composite="{Boolean}false"
                                    name="./cells">
                                    <field
                                        jcr:primaryType="nt:unstructured"
                                        sling:resourceType="granite/ui/components/coral/foundation/form/textfield"
                                        name="./cell"
                                        emptyText="Cell value"/>
                                </cells>

                            </items>
                        </field>
                    </rows>

                </items>
            </column>
        </items>
    </content>
</jcr:root>

package com.mysite.core.models;

import org.apache.sling.api.resource.Resource;
import org.apache.sling.models.annotations.DefaultInjectionStrategy;
import org.apache.sling.models.annotations.Exporter;
import org.apache.sling.models.annotations.Model;
import org.apache.sling.models.annotations.injectorspecific.ChildResource;

import javax.annotation.PostConstruct;
import java.util.ArrayList;
import java.util.List;

@Model(
        adaptables = Resource.class,
        adapters = PerformanceTableModel.class,
        resourceType = "mysite/components/content/performance-table",
        defaultInjectionStrategy = DefaultInjectionStrategy.OPTIONAL
)
@Exporter(name = "jackson", extensions = "json")
public class PerformanceTableModel {

    @ChildResource(name = "headers")
    private List<Resource> headerResources;

    @ChildResource(name = "rows")
    private List<Resource> rowResources;

    private List<String> headers;
    private List<Row> rows;

    @PostConstruct
    protected void init() {
        headers = new ArrayList<>();
        rows = new ArrayList<>();

        // 处理 headers multifield
        if (headerResources != null) {
            for (Resource r : headerResources) {
                String header = r.getValueMap().get("header", String.class);
                if (header != null && !header.isEmpty()) {
                    headers.add(header);
                }
            }
        }

        // 处理 rows + cells multifield
        if (rowResources != null) {
            for (Resource r : rowResources) {
                Row row = new Row();

                String rowLabel = r.getValueMap().get("rowLabel", String.class);
                row.setRowLabel(rowLabel);

                List<String> cells = new ArrayList<>();
                Resource cellsRes = r.getChild("cells");
                if (cellsRes != null) {
                    for (Resource c : cellsRes.getChildren()) {
                        String cellText = c.getValueMap().get("cell", String.class);
                        if (cellText != null) {
                            cells.add(cellText);
                        }
                    }
                }

                row.setCells(cells);
                rows.add(row);
            }
        }
    }

    // getters 给 React 用
    public List<String> getHeaders() {
        return headers;
    }

    public List<Row> getRows() {
        return rows;
    }

    // 内部 Row 类型，对应 JSON 中 rows 数组里的每一项
    public static class Row {
        private String rowLabel;
        private List<String> cells;

        public String getRowLabel() {
            return rowLabel;
        }

        public void setRowLabel(String rowLabel) {
            this.rowLabel = rowLabel;
        }

        public List<String> getCells() {
            return cells;
        }

        public void setCells(List<String> cells) {
            this.cells = cells;
        }
    }
}
