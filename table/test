// ResponsiveTable.js - React Component
import React from 'react';
import { MapTo } from '@adobe/aem-react-editable-components';
import './ResponsiveTable.css';

const ResponsiveTableConfig = {
  emptyLabel: 'Responsive Table',
  isEmpty: function(props) {
    return !props.tableHtml || props.tableHtml.trim() === '';
  }
};

const ResponsiveTable = (props) => {
  const { 
    tableHtml = '', 
    caption,
    striped = false,
    bordered = true,
    hoverable = true,
    responsive = true
  } = props;

  // Parse HTML table and extract data
  const parseTableHtml = (html) => {
    if (!html) return { headers: [], rows: [] };

    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const table = doc.querySelector('table');

    if (!table) return { headers: [], rows: [] };

    // Extract headers
    const headerCells = table.querySelectorAll('thead th, thead td');
    const headers = Array.from(headerCells).map(cell => cell.textContent.trim());

    // If no thead, try first row
    if (headers.length === 0) {
      const firstRow = table.querySelector('tr');
      if (firstRow) {
        const firstRowCells = firstRow.querySelectorAll('th, td');
        headers.push(...Array.from(firstRowCells).map(cell => cell.textContent.trim()));
      }
    }

    // Extract body rows
    const bodyRows = table.querySelectorAll('tbody tr');
    const rows = Array.from(bodyRows).map(row => {
      const cells = row.querySelectorAll('td, th');
      return Array.from(cells).map(cell => ({
        content: cell.innerHTML.trim(),
        isHeader: cell.tagName.toLowerCase() === 'th'
      }));
    });

    // If no tbody, get all rows except first (if it was used as header)
    if (rows.length === 0) {
      const allRows = table.querySelectorAll('tr');
      const startIndex = headers.length > 0 ? 1 : 0;
      
      for (let i = startIndex; i < allRows.length; i++) {
        const cells = allRows[i].querySelectorAll('td, th');
        rows.push(Array.from(cells).map(cell => ({
          content: cell.innerHTML.trim(),
          isHeader: cell.tagName.toLowerCase() === 'th'
        })));
      }
    }

    return { headers, rows };
  };

  if (!tableHtml || tableHtml.trim() === '') {
    return (
      <div className="cmp-table cmp-table--empty">
        <p>No table data available. Please configure the component in the dialog.</p>
      </div>
    );
  }

  const { headers, rows } = parseTableHtml(tableHtml);

  if (rows.length === 0) {
    return (
      <div className="cmp-table cmp-table--empty">
        <p>Unable to parse table data. Please check your table HTML.</p>
      </div>
    );
  }

  return (
    <div className={`cmp-table ${responsive ? 'cmp-table--responsive' : ''}`}>
      {caption && <div className="cmp-table__caption">{caption}</div>}
      
      <div className="cmp-table__wrapper">
        <table 
          className={`
            cmp-table__element
            ${striped ? 'cmp-table--striped' : ''}
            ${bordered ? 'cmp-table--bordered' : ''}
            ${hoverable ? 'cmp-table--hoverable' : ''}
          `.trim()}
        >
          {headers.length > 0 && (
            <thead className="cmp-table__head">
              <tr>
                {headers.map((header, idx) => (
                  <th 
                    key={idx} 
                    className="cmp-table__header"
                    dangerouslySetInnerHTML={{ __html: header }}
                  />
                ))}
              </tr>
            </thead>
          )}
          <tbody className="cmp-table__body">
            {rows.map((row, rowIdx) => (
              <tr key={rowIdx} className="cmp-table__row">
                {row.map((cell, cellIdx) => {
                  const CellTag = cell.isHeader ? 'th' : 'td';
                  return (
                    <CellTag
                      key={cellIdx} 
                      className={cell.isHeader ? "cmp-table__header" : "cmp-table__cell"}
                      data-label={headers[cellIdx] || `Column ${cellIdx + 1}`}
                      dangerouslySetInnerHTML={{ __html: cell.content }}
                    />
                  );
                })}
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>
  );
};

export default MapTo('myproject/components/content/responsivetable')(
  ResponsiveTable,
  ResponsiveTableConfig
);

// ResponsiveTable.css
.cmp-table {
  width: 100%;
  margin: 1rem 0;
}

.cmp-table__caption {
  font-size: 1.25rem;
  font-weight: 600;
  margin-bottom: 0.75rem;
  text-align: left;
}

.cmp-table__wrapper {
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.cmp-table__element {
  width: 100%;
  border-collapse: collapse;
  background-color: #fff;
}

.cmp-table__header {
  padding: 0.75rem 1rem;
  text-align: left;
  font-weight: 600;
  background-color: #f8f9fa;
  border-bottom: 2px solid #dee2e6;
}

.cmp-table__cell {
  padding: 0.75rem 1rem;
  border-bottom: 1px solid #dee2e6;
}

/* Preserve RTE formatting */
.cmp-table__cell p,
.cmp-table__header p {
  margin: 0;
}

.cmp-table__cell strong,
.cmp-table__header strong {
  font-weight: 600;
}

.cmp-table__cell em,
.cmp-table__header em {
  font-style: italic;
}

.cmp-table__cell a,
.cmp-table__header a {
  color: #0066cc;
  text-decoration: underline;
}

.cmp-table__cell ul,
.cmp-table__cell ol {
  margin: 0.5rem 0;
  padding-left: 1.5rem;
}

/* Striped rows */
.cmp-table--striped .cmp-table__body .cmp-table__row:nth-child(odd) {
  background-color: #f8f9fa;
}

/* Bordered table */
.cmp-table--bordered .cmp-table__header,
.cmp-table--bordered .cmp-table__cell {
  border: 1px solid #dee2e6;
}

/* Hoverable rows */
.cmp-table--hoverable .cmp-table__body .cmp-table__row:hover {
  background-color: #f1f3f5;
  transition: background-color 0.2s ease;
}

/* Empty state */
.cmp-table--empty {
  padding: 2rem;
  text-align: center;
  background-color: #f8f9fa;
  border: 2px dashed #dee2e6;
  border-radius: 4px;
  color: #6c757d;
}

/* Responsive styles for mobile */
@media screen and (max-width: 768px) {
  .cmp-table--responsive .cmp-table__element,
  .cmp-table--responsive .cmp-table__head,
  .cmp-table--responsive .cmp-table__body,
  .cmp-table--responsive .cmp-table__row,
  .cmp-table--responsive .cmp-table__header,
  .cmp-table--responsive .cmp-table__cell {
    display: block;
  }

  .cmp-table--responsive .cmp-table__head {
    display: none;
  }

  .cmp-table--responsive .cmp-table__row {
    margin-bottom: 1rem;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    overflow: hidden;
  }

  .cmp-table--responsive .cmp-table__cell {
    display: flex;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #dee2e6;
  }

  .cmp-table--responsive .cmp-table__cell:last-child {
    border-bottom: none;
  }

  .cmp-table--responsive .cmp-table__cell::before {
    content: attr(data-label);
    font-weight: 600;
    margin-right: 1rem;
    flex-shrink: 0;
    min-width: 120px;
  }

  .cmp-table--responsive .cmp-table__cell > * {
    flex: 1;
    text-align: right;
  }
}

/* Tablet breakpoint */
@media screen and (min-width: 769px) and (max-width: 1024px) {
  .cmp-table__header,
  .cmp-table__cell {
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
  }
}

// _cq_dialog/.content.xml - AEM Dialog with RTE Table Editor
<?xml version="1.0" encoding="UTF-8"?>
<jcr:root xmlns:sling="http://sling.apache.org/jcr/sling/1.0"
          xmlns:granite="http://www.adobe.com/jcr/granite/1.0"
          xmlns:cq="http://www.day.com/jcr/cq/1.0"
          xmlns:jcr="http://www.jcp.org/jcr/1.0"
          xmlns:nt="http://www.jcp.org/jcr/nt/1.0"
          jcr:primaryType="nt:unstructured"
          jcr:title="Responsive Table"
          sling:resourceType="cq/gui/components/authoring/dialog"
          extraClientlibs="[cq.widgets.rte]">
    <content
        jcr:primaryType="nt:unstructured"
        sling:resourceType="granite/ui/components/coral/foundation/container">
        <items jcr:primaryType="nt:unstructured">
            <tabs
                jcr:primaryType="nt:unstructured"
                sling:resourceType="granite/ui/components/coral/foundation/tabs"
                maximized="{Boolean}true">
                <items jcr:primaryType="nt:unstructured">
                    <general
                        jcr:primaryType="nt:unstructured"
                        jcr:title="General"
                        sling:resourceType="granite/ui/components/coral/foundation/container">
                        <items jcr:primaryType="nt:unstructured">
                            <columns
                                jcr:primaryType="nt:unstructured"
                                sling:resourceType="granite/ui/components/coral/foundation/fixedcolumns"
                                margin="{Boolean}true">
                                <items jcr:primaryType="nt:unstructured">
                                    <column
                                        jcr:primaryType="nt:unstructured"
                                        sling:resourceType="granite/ui/components/coral/foundation/container">
                                        <items jcr:primaryType="nt:unstructured">
                                            <caption
                                                jcr:primaryType="nt:unstructured"
                                                sling:resourceType="granite/ui/components/coral/foundation/form/textfield"
                                                fieldLabel="Table Caption"
                                                fieldDescription="Optional caption for the table"
                                                name="./caption"/>
                                            <tableHtml
                                                jcr:primaryType="nt:unstructured"
                                                sling:resourceType="cq/gui/components/authoring/dialog/richtext"
                                                fieldLabel="Table Content"
                                                fieldDescription="Create your table using the table editor"
                                                name="./tableHtml"
                                                useFixedInlineToolbar="{Boolean}true">
                                                <rtePlugins jcr:primaryType="nt:unstructured">
                                                    <table
                                                        jcr:primaryType="nt:unstructured"
                                                        features="[table,modifytable,insertrow,removerow,insertcolumn,removecolumn,cellprops,mergecells,selectrow,selectcolumn]"/>
                                                    <format
                                                        jcr:primaryType="nt:unstructured"
                                                        features="[bold,italic,underline]"/>
                                                    <links
                                                        jcr:primaryType="nt:unstructured"
                                                        features="[modifylink,unlink]"/>
                                                    <lists
                                                        jcr:primaryType="nt:unstructured"
                                                        features="[ordered,unordered]"/>
                                                    <paraformat
                                                        jcr:primaryType="nt:unstructured"
                                                        features="*">
                                                        <formats jcr:primaryType="nt:unstructured">
                                                            <default
                                                                jcr:primaryType="nt:unstructured"
                                                                description="Paragraph"
                                                                tag="p"/>
                                                            <h1
                                                                jcr:primaryType="nt:unstructured"
                                                                description="Heading 1"
                                                                tag="h1"/>
                                                            <h2
                                                                jcr:primaryType="nt:unstructured"
                                                                description="Heading 2"
                                                                tag="h2"/>
                                                            <h3
                                                                jcr:primaryType="nt:unstructured"
                                                                description="Heading 3"
                                                                tag="h3"/>
                                                        </formats>
                                                    </paraformat>
                                                    <edit
                                                        jcr:primaryType="nt:unstructured"
                                                        features="[cut,copy,paste-default,paste-plaintext,paste-wordhtml]"/>
                                                    <undo
                                                        jcr:primaryType="nt:unstructured"
                                                        features="[undo,redo]"/>
                                                </rtePlugins>
                                                <uiSettings jcr:primaryType="nt:unstructured">
                                                    <cui jcr:primaryType="nt:unstructured">
                                                        <inline
                                                            jcr:primaryType="nt:unstructured"
                                                            toolbar="[format#bold,format#italic,format#underline,#links,#lists,#paraformat,table#table,table#modifytable,table#insertrow,table#removerow,table#insertcolumn,table#removecolumn]">
                                                            <popovers jcr:primaryType="nt:unstructured">
                                                                <table
                                                                    jcr:primaryType="nt:unstructured"
                                                                    items="[table#insertcolumn-before,table#insertcolumn-after,table#removecolumn,table#insertrow-before,table#insertrow-after,table#removerow,table#cellprops,table#mergecells,table#splitcell,table#selectrow,table#selectcolumn,-,table#removetable]"
                                                                    ref="table"/>
                                                            </popovers>
                                                        </inline>
                                                    </cui>
                                                </uiSettings>
                                            </tableHtml>
                                        </items>
                                    </column>
                                </items>
                            </columns>
                        </items>
                    </general>
                    <options
                        jcr:primaryType="nt:unstructured"
                        jcr:title="Options"
                        sling:resourceType="granite/ui/components/coral/foundation/container">
                        <items jcr:primaryType="nt:unstructured">
                            <columns
                                jcr:primaryType="nt:unstructured"
                                sling:resourceType="granite/ui/components/coral/foundation/fixedcolumns"
                                margin="{Boolean}true">
                                <items jcr:primaryType="nt:unstructured">
                                    <column
                                        jcr:primaryType="nt:unstructured"
                                        sling:resourceType="granite/ui/components/coral/foundation/container">
                                        <items jcr:primaryType="nt:unstructured">
                                            <striped
                                                jcr:primaryType="nt:unstructured"
                                                sling:resourceType="granite/ui/components/coral/foundation/form/checkbox"
                                                fieldDescription="Enable striped rows for better readability"
                                                name="./striped"
                                                text="Striped Rows"
                                                value="{Boolean}true"/>
                                            <bordered
                                                jcr:primaryType="nt:unstructured"
                                                sling:resourceType="granite/ui/components/coral/foundation/form/checkbox"
                                                fieldDescription="Add borders around cells"
                                                name="./bordered"
                                                text="Bordered"
                                                checked="{Boolean}true"
                                                value="{Boolean}true"/>
                                            <hoverable
                                                jcr:primaryType="nt:unstructured"
                                                sling:resourceType="granite/ui/components/coral/foundation/form/checkbox"
                                                fieldDescription="Enable hover effect on rows"
                                                name="./hoverable"
                                                text="Hoverable Rows"
                                                checked="{Boolean}true"
                                                value="{Boolean}true"/>
                                            <responsive
                                                jcr:primaryType="nt:unstructured"
                                                sling:resourceType="granite/ui/components/coral/foundation/form/checkbox"
                                                fieldDescription="Make table responsive on mobile devices"
                                                name="./responsive"
                                                text="Responsive Layout"
                                                checked="{Boolean}true"
                                                value="{Boolean}true"/>
                                        </items>
                                    </column>
                                </items>
                            </columns>
                        </items>
                    </options>
                </items>
            </tabs>
        </items>
    </content>
</jcr:root>

// ResponsiveTableModel.java - Updated Sling Model
package com.myproject.core.models;

import com.adobe.cq.export.json.ComponentExporter;
import com.adobe.cq.export.json.ExporterConstants;
import org.apache.sling.api.SlingHttpServletRequest;
import org.apache.sling.models.annotations.DefaultInjectionStrategy;
import org.apache.sling.models.annotations.Exporter;
import org.apache.sling.models.annotations.Model;
import org.apache.sling.models.annotations.injectorspecific.ValueMapValue;

@Model(
    adaptables = SlingHttpServletRequest.class,
    adapters = {ResponsiveTableModel.class, ComponentExporter.class},
    resourceType = ResponsiveTableModel.RESOURCE_TYPE,
    defaultInjectionStrategy = DefaultInjectionStrategy.OPTIONAL
)
@Exporter(
    name = ExporterConstants.SLING_MODEL_EXPORTER_NAME,
    extensions = ExporterConstants.SLING_MODEL_EXTENSION
)
public class ResponsiveTableModel implements ComponentExporter {

    static final String RESOURCE_TYPE = "myproject/components/content/responsivetable";

    @ValueMapValue
    private String caption;

    @ValueMapValue
    private String tableHtml;

    @ValueMapValue
    private Boolean striped;

    @ValueMapValue
    private Boolean bordered;

    @ValueMapValue
    private Boolean hoverable;

    @ValueMapValue
    private Boolean responsive;

    public String getCaption() {
        return caption;
    }

    public String getTableHtml() {
        return tableHtml;
    }

    public Boolean getStriped() {
        return striped != null ? striped : false;
    }

    public Boolean getBordered() {
        return bordered != null ? bordered : true;
    }

    public Boolean getHoverable() {
        return hoverable != null ? hoverable : true;
    }

    public Boolean getResponsive() {
        return responsive != null ? responsive : true;
    }

    @Override
    public String getExportedType() {
        return RESOURCE_TYPE;
    }
}

// .content.xml - Component Definition
<?xml version="1.0" encoding="UTF-8"?>
<jcr:root xmlns:cq="http://www.day.com/jcr/cq/1.0"
          xmlns:jcr="http://www.jcp.org/jcr/1.0"
          jcr:primaryType="cq:Component"
          jcr:title="Responsive Table"
          jcr:description="A responsive table component with rich text editing capabilities"
          componentGroup="MyProject - Content"/>

// import-components.js
import './components/ResponsiveTable/ResponsiveTable';

// Example: How authors will use it in AEM
/*
1. Drag the "Responsive Table" component onto the page
2. Open the dialog
3. Use the rich text editor to create a table:
   - Click the table icon in the toolbar
   - Select rows and columns
   - Fill in content with formatting (bold, italic, links, etc.)
   - Use table tools to add/remove rows and columns
4. Configure options (striped, bordered, etc.)
5. Save

The table will automatically be responsive on mobile!
*/



Gotcha — if this is **only for the authoring dialog** and you *don’t* want any width behavior to leak into the React SPA render, then you should **solve this purely with CSS in an authoring-only clientlib**, not by modifying the table HTML.

That way:

* Authors get nice wide cells while editing in the RTE dialog.
* No `style="width:..."` or classes are stored in the content.
* Your React SPA sees “clean” HTML and can style tables however it wants.

---

## 1. Core idea

Instead of changing cell **properties**, just style the RTE’s editable area in **author mode only**:

```css
/* Authoring-only clientlib */
.cq-RichText-editable table td,
.cq-RichText-editable table th {
  min-width: 120px;   /* or whatever default width you want */
}
```

Because this CSS is loaded **only inside the dialog**, it never affects the published React app.

New columns & cells inserted in the RTE automatically use this min width because the rule targets **all table cells while editing**.

---

## 2. Create an authoring-only clientlib

Under `/apps`, create something like:

**Node structure:**

```text
/apps/your-project/clientlibs/rte-table-author
  - jcr:primaryType = cq:ClientLibraryFolder
  - categories = ["yourproject.rte.table.author"]
  - allowProxy = true
  /css
    - jcr:primaryType = nt:folder
    /table-author.css
      - jcr:primaryType = nt:file
  - css.txt
```

**`css.txt`:**

```text
table-author.css
```

**`table-author.css`:**

```css
/* Apply only inside RTE editing area */
.cq-RichText-editable table td,
.cq-RichText-editable table th {
  min-width: 120px; /* default visual width for better editing */
  /* optional: padding, border to make them easier to click */
  /* padding: 4px; */
}

/* If you ONLY want this in dialogs, you can further scope it, e.g.: */
.coral-Dialog .cq-RichText-editable table td,
.coral-Dialog .cq-RichText-editable table th {
  min-width: 120px;
}
```

No classes or inline styles are added to the HTML — this is just styling the editing iframe.

---

## 3. Attach the clientlib to your component dialog

In your component’s dialog (e.g. `/apps/your-project/components/my-component/_cq_dialog/.content.xml`):

```xml
<jcr:root
    xmlns:sling="http://sling.apache.org/jcr/sling/1.0"
    xmlns:jcr="http://www.jcp.org/jcr/1.0"
    jcr:primaryType="nt:unstructured"
    sling:resourceType="cq/gui/components/authoring/dialog"
    extraClientlibs="[yourproject.rte.table.author]">
    <!-- dialog content -->
</jcr:root>
```

Now:

* Whenever this dialog opens, AEM loads your `yourproject.rte.table.author` clientlib.
* The RTE inside gets the `min-width` styling for table cells.
* Your React SPA on publish **never sees this CSS**, so nothing changes there.

---

## 4. Optional: only for empty cells

If you really only want “wide for empty cells” and don’t care once they type, you can try a variant like:

```css
.cq-RichText-editable table td:empty,
.cq-RichText-editable table th:empty {
  min-width: 120px;
}
```

But note: the RTE often inserts `<br>` into empty cells, so `:empty` may not match reliably. The simple `td, th` rule is usually good enough for editing comfort.

---

## 5. Summary

* **Don’t** modify the table HTML or cell properties (that would persist into content and affect React).
* **Do** add an **author-only clientlib** and use CSS to give table cells a comfortable min-width inside the RTE dialog.
* Attach that clientlib via `extraClientlibs` on the dialog so it never loads on the actual SPA page.

If you paste your dialog/RTE XML, I can tweak the exact selectors and `extraClientlibs` value to match your project.
