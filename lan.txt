import React, { useMemo, useState } from "react";
import { Converter } from "opencc-js";

/**
 * æ··åˆæ¨¡å¼ï¼ˆä¿æŒåŸå§‹å¤§ JSON + è¯­è¨€è¦†ç›–ï¼‰å®Œæ•´ Demo
 * -------------------------------------------------
 * - baseProps: ä¸€ä¸ªåŒ…å«ã€Œå‚æ•° + è‹±æ–‡æ–‡æ¡ˆã€çš„å¤§ JSONï¼ˆé€šå¸¸ä»æœåŠ¡å™¨æˆ–æœ¬åœ°æ–‡ä»¶æ¥ï¼‰
 * - zhOverride: åªåŒ…å«éœ€è¦æ”¹å†™æˆä¸­æ–‡çš„æ–‡æ¡ˆå­—æ®µï¼ˆç»“æ„ä¸ base å¯¹é½çš„å­é›†ï¼‰
 * - getLocaleProps(locale): è¿”å›åˆå¹¶åçš„ propsï¼Œå‚æ•°ä¸è¢«è¦†ç›–ï¼Œåªè¦†ç›–æ–‡æ¡ˆ
 *
 * ä½ å¯ä»¥æŠŠä¸‹é¢ä¸¤æ®µ JSON æ”¹æˆä»æ–‡ä»¶å¯¼å…¥ï¼š
 * import baseProps from "./config.json";
 * import zhOverride from "./locales/zh.json";
 */

// 1) æ¨¡æ‹Ÿä¸€ä¸ªè¾ƒå¤æ‚çš„ base JSONï¼šæ—¢æœ‰æ–‡æ¡ˆä¹Ÿæœ‰é…ç½®å‚æ•°
const baseProps = {
  meta: {
    id: "demo-card",
    version: 1,
  },
  content: {
    header: {
      title: "Welcome to the Demo",
      subtitle: "This demonstrates the hybrid i18n approach.",
    },
    sections: [
      {
        key: "features",
        title: "Key Features",
        items: [
          { icon: "âš¡", label: "Fast", desc: "Works quickly with minimal setup." },
          { icon: "ğŸ§©", label: "Modular", desc: "Drop-in replacement for your current JSON." },
          { icon: "ğŸ›¡ï¸", label: "Safe", desc: "Keeps config separate from translations." },
        ],
      },
      {
        key: "cta",
        title: "Get Started",
        description: "Click the button below to explore.",
      },
    ],
  },
  config: {
    theme: "light", // å¯åˆ‡ä¸º "dark"
    showHeader: true,
    showFooter: true,
    layout: {
      container: "max-w-3xl",
      cardPadding: "p-6",
      rounded: "rounded-2xl",
      shadow: "shadow-xl",
    },
  },
};

// 2) åªåŒ…å«ä¸­æ–‡æ–‡æ¡ˆè¦†ç›–ï¼ˆä¸åŒ…å« config ç­‰é€»è¾‘å‚æ•°ï¼‰
const zhOverride = {
  // è¿™é‡Œæ•…æ„ä½¿ç”¨ã€Œç¹é«”ä¸­æ–‡ã€ï¼Œç¨å¾Œæ¼”ç¤ºè‡ªå‹•è½‰ç‚ºã€Œç®€ä½“ä¸­æ–‡ã€
  content: {
    header: {
      title: "æ­¡è¿ä¾†åˆ°ç¤ºä¾‹",
      subtitle: "é€™è£¡æ¼”ç¤ºæ··åˆå¼åœ‹éš›åŒ–è¦†è“‹ã€‚",
    },
    sections: [
      {
        key: "features",
        title: "æ ¸å¿ƒç‰¹æ€§",
        items: [
          { label: "å¿«é€Ÿ", desc: "æ¥µå°‘æ”¹é€ å°±èƒ½ä½¿ç”¨ã€‚" },
          { label: "æ¨¡çµ„åŒ–", desc: "å¯ä½œç‚ºä½ ç¾æœ‰ JSON çš„æ›¿æ›ä»¶ã€‚" },
          { label: "å®‰å…¨", desc: "å°‡é…ç½®èˆ‡ç¿»è­¯è§£è€¦ï¼Œäº’ä¸å½±éŸ¿ã€‚" },
        ],
      },
      {
        key: "cta",
        title: "é–‹å§‹ä½¿ç”¨",
        description: "é»æ“Šä¸‹æ–¹æŒ‰éˆ•ç¹¼çºŒæ¢ç´¢ã€‚",
      },
    ],
  },
};

/**
 * 3) æ·±åº¦åˆå¹¶å·¥å…·ï¼ˆåªè¦†ç›–æ–‡æ¡ˆï¼Œä¸è¦†ç›– config ç­‰å‚æ•°ï¼‰
 * è§„åˆ™ï¼š
 * - å¯¹è±¡ï¼šé€’å½’åˆå¹¶
 * - æ•°ç»„ï¼šé’ˆå¯¹å« key çš„æ•°ç»„ï¼ŒæŒ‰ key å½’å¹¶ï¼›å¦åˆ™æŒ‰ç´¢å¼•è¦†ç›–ï¼ˆä»…å½“ override é¡¹å­˜åœ¨ï¼‰
 * - åŸºæœ¬ç±»å‹ï¼šoverride è‹¥ä¸º string æˆ– number æˆ– booleanï¼Œåˆ™è¦†ç›–ï¼›å¦åˆ™ä¿ç•™ base
 */
function deepMergeContentOnly(base: any, override: any): any {
  if (override === undefined || override === null) return base;

  // åŸºæœ¬ç±»å‹ç›´æ¥è¦†ç›–ï¼ˆé€šå¸¸æ˜¯ string æ–‡æ¡ˆï¼‰
  if (typeof base !== "object" || base === null) return override;
  if (typeof override !== "object" || override === null) return override;

  // æ•°ç»„ï¼šä¼˜å…ˆæŒ‰ key å¯¹é½å½’å¹¶
  if (Array.isArray(base) && Array.isArray(override)) {
    const byKey = (arr: any[]) =>
      arr.every((x) => x && typeof x === "object" && "key" in x);

    if (byKey(base) && byKey(override)) {
      const map = new Map(base.map((x: any) => [x.key, x]));
      for (const o of override) {
        if (map.has(o.key)) {
          map.set(o.key, deepMergeContentOnly(map.get(o.key), o));
        } else {
          map.set(o.key, o);
        }
      }
      return Array.from(map.values());
    }

    // å¦åˆ™æŒ‰ç´¢å¼•è¦†ç›–ï¼ˆoverride æ²¡æä¾›çš„ç´¢å¼•ä¿ç•™ baseï¼‰
    const maxLen = Math.max(base.length, override.length);
    const merged: any[] = [];
    for (let i = 0; i < maxLen; i++) {
      merged[i] = deepMergeContentOnly(base[i], override[i]);
    }
    return merged;
  }

  // å¯¹è±¡ï¼šé€å­—æ®µé€’å½’åˆå¹¶
  const out: any = { ...base };
  for (const k of Object.keys(override)) {
    out[k] = deepMergeContentOnly(base[k], override[k]);
  }
  return out;
}

/**
 * 4) ç”Ÿæˆ locale å¯¹åº”çš„ props
 * ä»…å¯¹ content å­—æ®µåšè¦†ç›–ï¼Œconfig ç­‰å‚æ•°ä¿æŒ base ä¸å˜
 */
function mapStringsDeep(input: any, mapFn: (s: string) => string): any {
  if (input == null) return input;
  if (typeof input === "string") return mapFn(input);
  if (Array.isArray(input)) return input.map((x) => mapStringsDeep(x, mapFn));
  if (typeof input === "object") {
    const out: any = Array.isArray(input) ? [] : { ...input };
    for (const k of Object.keys(input)) out[k] = mapStringsDeep((input as any)[k], mapFn);
    return out;
  }
  return input;
}

// é å…ˆæ§‹å»ºç¹â†’ç°¡è½‰æ›å™¨
const toSimplified = Converter({ from: "tw", to: "cn" });

function getLocaleProps(locale: "en" | "zh-Hant" | "zh-Hans") {
  if (locale === "zh-Hant" || locale === "zh-Hans") {
    // å…ˆç”¨ç¹é«”è¦†è“‹ï¼Œå†æŒ‰éœ€è½‰ç°¡é«”
    const merged = {
      ...baseProps,
      content: deepMergeContentOnly(baseProps.content, zhOverride.content),
    };
    if (locale === "zh-Hans") {
      return {
        ...merged,
        content: mapStringsDeep(merged.content, (s) => toSimplified(s)),
      };
    }
    return merged;
  }
  return baseProps;
};
  }
  return baseProps;
}

/** UI å°ç»„ä»¶ **/
function Toggle({ checked, onChange, label }: { checked: boolean; onChange: (v: boolean) => void; label?: string }) {
  return (
    <label className="inline-flex items-center gap-2 cursor-pointer select-none">
      <span className="text-sm text-gray-600">{label}</span>
      <span className={`w-12 h-7 flex items-center ${checked ? "bg-gray-900" : "bg-gray-300"} rounded-full p-1 transition-colors`} onClick={() => onChange(!checked)}>
        <span className={`bg-white w-5 h-5 rounded-full shadow transform transition-transform ${checked ? "translate-x-5" : "translate-x-0"}`} />
      </span>
    </label>
  );
}

function Section({ title, children }: { title: string; children?: React.ReactNode }) {
  return (
    <section className="mt-6">
      <h3 className="text-lg font-semibold mb-2">{title}</h3>
      <div className="space-y-2 text-gray-700">{children}</div>
    </section>
  );
}

function FeatureItem({ icon, label, desc }: { icon: string; label: string; desc: string }) {
  return (
    <div className="flex items-start gap-3">
      <div className="text-2xl leading-none">{icon}</div>
      <div>
        <div className="font-medium">{label}</div>
        <div className="text-sm text-gray-600">{desc}</div>
      </div>
    </div>
  );
}

/**
 * 5) ç›®æ ‡ç»„ä»¶ï¼šæ¥å—æ··åˆåçš„ props
 */
function HybridCard(props: typeof baseProps) {
  const { content, config } = props;
  const { layout, theme, showHeader, showFooter } = config;

  return (
    <div className={`${theme === "dark" ? "bg-gray-950 text-white" : "bg-gray-50 text-gray-900"} min-h-screen py-10`}> 
      <div className={`${layout.container} mx-auto px-4`}>
        <div className={`bg-white ${layout.cardPadding} ${layout.rounded} ${layout.shadow} ${theme === "dark" ? "bg-gray-900 text-white" : "bg-white"}`}>
          {showHeader && (
            <header className="mb-4">
              <h1 className="text-2xl font-bold">{content.header.title}</h1>
              <p className="text-gray-600 dark:text-gray-300">{content.header.subtitle}</p>
            </header>
          )}

          {content.sections.map((sec: any) => (
            <Section key={sec.key} title={sec.title}>
              {sec.items && sec.items.map((it: any, idx: number) => (
                <FeatureItem key={idx} icon={it.icon ?? "â€¢"} label={it.label} desc={it.desc} />
              ))}
              {sec.description && <p>{sec.description}</p>}
              {sec.key === "cta" && (
                <button className="mt-2 inline-flex items-center justify-center rounded-xl px-4 py-2 bg-gray-900 text-white hover:opacity-90 active:opacity-80">
                  {sec.buttonLabel ?? "Continue"}
                </button>
              )}
            </Section>
          ))}

          {showFooter && (
            <footer className="mt-8 pt-4 border-t border-gray-200 text-sm text-gray-500">
              id: {props.meta.id} Â· v{props.meta.version} Â· theme: {theme}
            </footer>
          )}
        </div>
      </div>
    </div>
  );
}

/**
 * 6) Demo å®¹å™¨ï¼šåˆ‡æ¢ä¸­è‹±æ–‡è§‚å¯Ÿè¦†ç›–æ•ˆæœï¼›æ¼”ç¤º theme/config æœªè¢«è¦†ç›–
 */
export default function App() {
  const [useZh, setUseZh] = useState(true);        // æ˜¯å¦ä½¿ç”¨ä¸­æ–‡ï¼ˆç¹/ç®€ï¼‰
  const [useHans, setUseHans] = useState(true);    // ä¸­æ–‡æ—¶æ˜¯å¦ç”¨ç®€ä½“
  const [dark, setDark] = useState(false);

  const props = useMemo(() => {
    const locale = useZh ? (useHans ? "zh-Hans" : "zh-Hant") : ("en" as const);
    const p = getLocaleProps(locale);
    return {
      ...p,
      config: {
        ...p.config,
        theme: dark ? "dark" : "light",
      },
    };
  }, [useZh, useHans, dark]);

  return (
    <div className="min-h-screen bg-gradient-to-b from-gray-100 to-gray-200">
      <div className="max-w-5xl mx-auto px-4 py-6">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-xl font-semibold">Hybrid i18n Props Merge Demoï¼ˆç¹â†’ç®€è‡ªå‹•è½‰æ›ï¼‰</h2>
          <div className="flex items-center gap-4">
            <Toggle checked={useZh} onChange={setUseZh} label="ä¸­æ–‡" />
            {useZh && <Toggle checked={useHans} onChange={setUseHans} label="ç¹â†’ç®€" />}
            <Toggle checked={dark} onChange={setDark} label="Dark" />
          </div>
        </div>
        <HybridCard {...props} />
      </div>
    </div>
  );
},
    };
  }, [zh, dark]);

  return (
    <div className="min-h-screen bg-gradient-to-b from-gray-100 to-gray-200">
      <div className="max-w-5xl mx-auto px-4 py-6">
        <div className="flex items-center justify-between mb-4">
          <h2 className="text-xl font-semibold">Hybrid i18n Props Merge Demo</h2>
          <div className="flex items-center gap-4">
            <Toggle checked={zh} onChange={setZh} label="ä¸­æ–‡" />
            <Toggle checked={dark} onChange={setDark} label="Dark" />
          </div>
        </div>
        <HybridCard {...props} />
      </div>
    </div>
  );
}
